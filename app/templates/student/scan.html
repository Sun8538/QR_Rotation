{% extends "base.html" %}

{% block title %}Scan QR Code - Smart Attendance Management System{% endblock %}

{% block extra_head %}
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-50 via-purple-50 to-blue-50">
    <!-- Enhanced Navigation -->
    <nav class="bg-white shadow-lg border-b-4 border-purple-500 animate-fade-in-down">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-20 items-center">
                <div class="flex items-center">
                    <a href="{{ url_for('student.dashboard') }}" class="text-gray-500 hover:text-purple-700 mr-4 transform hover:scale-110 transition duration-300">
                        <i class="fas fa-arrow-left text-xl"></i>
                    </a>
                    <div class="bounce-in">
                        <i class="fas fa-qrcode text-purple-600 text-3xl mr-3"></i>
                    </div>
                    <span class="text-gray-900 text-2xl font-bold bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent">Scan QR Code</span>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-4xl mx-auto px-4 py-10">
        <!-- Enhanced Instructions Card -->
        <div class="bg-white rounded-2xl shadow-xl border-2 border-purple-100 p-8 mb-8 animate-fade-in-up card-hover">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
                <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-500 rounded-xl flex items-center justify-center mr-4 bounce-in">
                    <i class="fas fa-info-circle text-white text-xl"></i>
                </div>
                How to Scan
            </h2>
            <ol class="list-decimal list-inside space-y-3 text-gray-700 text-lg">
                <li class="flex items-start space-x-3 animate-fade-in-left stagger-delay-1">
                    <span class="flex-shrink-0 w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center text-purple-600 font-bold text-sm">1</span>
                    <span>Allow camera access when prompted for scanning</span>
                </li>
                <li class="flex items-start space-x-3 animate-fade-in-left stagger-delay-2">
                    <span class="flex-shrink-0 w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center text-purple-600 font-bold text-sm">2</span>
                    <span>Point your camera at the QR code displayed by your professor</span>
                </li>
                <li class="flex items-start space-x-3 animate-fade-in-left stagger-delay-3">
                    <span class="flex-shrink-0 w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center text-purple-600 font-bold text-sm">3</span>
                    <span>Hold steady until the code is recognized automatically</span>
                </li>
                <li class="flex items-start space-x-3 animate-fade-in-left stagger-delay-4">
                    <span class="flex-shrink-0 w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center text-purple-600 font-bold text-sm">4</span>
                    <span>Your attendance will be recorded instantly! ✅</span>
                </li>
            </ol>
        </div>

        <!-- Enhanced Scanner Area -->
        <div class="bg-white rounded-2xl shadow-2xl border-2 border-purple-100 p-8 mb-8 animate-fade-in-up stagger-delay-1">
            <div id="reader-container" class="relative">
                <div id="reader" class="w-full aspect-square rounded-2xl overflow-hidden border-4 border-purple-200 shadow-inner"></div>
                <div id="scanner-overlay" class="absolute inset-0 flex items-center justify-center bg-gray-900/70 rounded-2xl hidden backdrop-blur-sm">
                    <div class="text-center text-white">
                        <div class="w-20 h-20 border-4 border-purple-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                        <p class="text-xl font-semibold">Processing...</p>
                    </div>
                </div>
            </div>
            
            <div class="mt-6 flex justify-center space-x-4">
                <button id="start-btn" onclick="startScanner()" 
                    class="bg-gradient-to-r from-purple-600 to-blue-600 text-white px-8 py-4 rounded-xl hover:from-purple-700 hover:to-blue-700 transition duration-300 flex items-center text-lg font-bold shadow-xl transform hover:scale-110">
                    <i class="fas fa-camera mr-3"></i> Start Camera
                </button>
                <button id="stop-btn" onclick="stopScanner()" 
                    class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-8 py-4 rounded-xl hover:from-gray-600 hover:to-gray-700 transition duration-300 flex items-center text-lg font-bold shadow-xl transform hover:scale-110 hidden">
                    <i class="fas fa-stop mr-3"></i> Stop
                </button>
            </div>
        </div>

        <!-- Enhanced Result Area -->
        <div id="result-area" class="hidden animate-fade-in-up">
            <div id="result-success" class="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-400 rounded-2xl p-8 shadow-xl hidden animate-zoom-in">
                <div class="flex items-center mb-6">
                    <div class="w-16 h-16 bg-gradient-to-br from-green-500 to-emerald-500 rounded-full flex items-center justify-center mr-5 shadow-lg bounce-in">
                        <i class="fas fa-check text-white text-3xl"></i>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-green-800">Attendance Marked Successfully! ✅</h3>
                        <p id="result-message" class="text-green-700 text-lg"></p>
                    </div>
                </div>
                <div id="result-details" class="bg-white rounded-xl p-6 mt-6 shadow-lg">
                    <!-- Details will be inserted here -->
                </div>
            </div>

            <div id="result-error" class="bg-gradient-to-r from-red-50 to-pink-50 border-2 border-red-400 rounded-2xl p-8 shadow-xl hidden animate-zoom-in">
                <div class="flex items-center">
                    <div class="w-16 h-16 bg-gradient-to-br from-red-500 to-pink-500 rounded-full flex items-center justify-center mr-5 shadow-lg bounce-in">
                        <i class="fas fa-times text-white text-3xl"></i>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-red-800">Error ❌</h3>
                        <p id="error-message" class="text-red-700 text-lg"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Manual Entry with Enhanced Design -->
        <div class="bg-white rounded-2xl shadow-xl border-2 border-purple-100 p-8 mt-8 animate-fade-in-up stagger-delay-2">
            <h3 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
                <i class="fas fa-keyboard mr-3 text-purple-600"></i> Manual QR Data Entry (Testing)
            </h3>
            <form id="manual-form" onsubmit="submitManualQR(event)">
                <textarea id="manual-qr" rows="5" 
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                    placeholder='Paste QR data JSON here...'></textarea>
                <button type="submit" class="mt-3 bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700">
                    Submit
                </button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let html5QrcodeScanner = null;
let studentLocation = null;

// Get student's location on page load
document.addEventListener('DOMContentLoaded', function() {
    // Request geolocation permission
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                studentLocation = {
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude,
                    accuracy: position.coords.accuracy
                };
                console.log('Location captured:', studentLocation);
            },
            function(error) {
                console.warn('Location permission denied or unavailable:', error.message);
                // Continue without location - server will handle verification
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            }
        );
    }
    
    // Check for QR data in URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const qrData = urlParams.get('data');
    if (qrData) {
        processQRCode(qrData);
    }
});

function startScanner() {
    document.getElementById('start-btn').classList.add('hidden');
    document.getElementById('stop-btn').classList.remove('hidden');
    document.getElementById('result-area').classList.add('hidden');
    
    html5QrcodeScanner = new Html5Qrcode("reader");
    
    html5QrcodeScanner.start(
        { facingMode: "environment" },
        {
            fps: 20,
            qrbox: { width: 400, height: 400 },
            aspectRatio: 1.0
        },
        onScanSuccess,
        onScanFailure
    ).catch(err => {
        console.error("Error starting scanner:", err);
        alert("Error starting camera. Please ensure camera permission is granted.");
        stopScanner();
    });
}

function stopScanner() {
    if (html5QrcodeScanner) {
        html5QrcodeScanner.stop().then(() => {
            document.getElementById('start-btn').classList.remove('hidden');
            document.getElementById('stop-btn').classList.add('hidden');
        }).catch(err => console.error("Error stopping scanner:", err));
    }
}

function onScanSuccess(decodedText, decodedResult) {
    console.log("QR Code detected:", decodedText);
    stopScanner();
    processQRCode(decodedText);
}

function onScanFailure(error) {
    // Ignore scan failures (happens continuously while scanning)
}

function processQRCode(qrData) {
    document.getElementById('scanner-overlay').classList.remove('hidden');
    
    // Try to parse the QR data
    let parsedData;
    try {
        // Check if it's a URL with data parameter
        if (qrData.includes('?data=')) {
            const url = new URL(qrData);
            const dataParam = url.searchParams.get('data');
            parsedData = JSON.parse(dataParam);
        } else {
            parsedData = JSON.parse(qrData);
        }
    } catch (e) {
        showError("Invalid QR code format");
        document.getElementById('scanner-overlay').classList.add('hidden');
        return;
    }
    
    // Prepare request data with location
    const requestData = {
        qr_data: parsedData,
        location: studentLocation
    };
    
    // Send to server
    fetch('/student/scan/process', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('scanner-overlay').classList.add('hidden');
        
        if (data.success) {
            showSuccess(data.message, data.attendance);
        } else {
            showError(data.error);
        }
    })
    .catch(error => {
        document.getElementById('scanner-overlay').classList.add('hidden');
        showError("Network error. Please try again.");
    });
}

function showSuccess(message, attendance) {
    document.getElementById('result-area').classList.remove('hidden');
    document.getElementById('result-success').classList.remove('hidden');
    document.getElementById('result-error').classList.add('hidden');
    document.getElementById('result-message').textContent = message;
    
    let details = `
        <div class="space-y-2">
            <p><strong>Status:</strong> <span class="capitalize">${attendance.status}</span></p>
            <p><strong>Class:</strong> ${attendance.class.code} - ${attendance.class.name}</p>
            <p><strong>Time:</strong> ${new Date(attendance.scanned_at).toLocaleTimeString()}</p>
            ${attendance.minutes_late > 0 ? `<p><strong>Minutes Late:</strong> ${attendance.minutes_late}</p>` : ''}
        </div>
    `;
    document.getElementById('result-details').innerHTML = details;
}

function showError(message) {
    document.getElementById('result-area').classList.remove('hidden');
    document.getElementById('result-success').classList.add('hidden');
    document.getElementById('result-error').classList.remove('hidden');
    document.getElementById('error-message').textContent = message;
}

function submitManualQR(event) {
    event.preventDefault();
    const qrData = document.getElementById('manual-qr').value;
    if (qrData) {
        processQRCode(qrData);
    }
}
</script>
{% endblock %}
